import json
import os
import random
from datetime import datetime, timedelta
from models.models import Joueur, Tournoi, Round, Match


class Controller:
    def __init__(self, joueur_model, tournoi_model, view):
        self.joueur_model = joueur_model
        self.tournoi_model = tournoi_model
        self.view = view
        self.joueurs_path = os.path.join('data', 'Données_des_Participants.json')
        self.tournois_path = os.path.join('data', 'tournois.json')
        os.makedirs(os.path.dirname(self.joueurs_path), exist_ok=True)
        os.makedirs(os.path.dirname(self.tournois_path), exist_ok=True)

    def run(self):
        while True:
            self.view.afficher_menu_principal()
            choix = input("Entrez le numéro de votre choix : ")

            if choix == "1":
                self.creer_tournoi()
            elif choix == "2":
                self.ajouter_joueur()
            elif choix == "3":
                self.afficher_tous_les_joueurs()
            elif choix == "4":
                self.afficher_tous_les_tournois()
            elif choix == "5":
                self.lancer_tournoi()
            elif choix == "6":
                self.generer_rapport_joueurs()
            elif choix == "7":
                self.generer_rapport_tournois()
            elif choix == "8":
                self.view.afficher_message("Merci d'avoir utilisé l'application. Au revoir !")
                break
            else:
                self.view.afficher_erreur("Choix invalide. Veuillez entrer un numéro valide.")

    def creer_tournoi(self):
        self.view.afficher_message("Création d'un nouveau tournoi")
        joueurs_disponibles = self.charger_joueurs_inscrits()

        if len(joueurs_disponibles) < 5:
            self.view.afficher_erreur("Vous devez inscrire au moins 5 joueurs avant de créer un tournoi.")
            return

        nom = input("Nom du tournoi : ")
        lieu = input("Lieu du tournoi : ")
        date_debut = self.saisir_date("Date de début (format JJ/MM/AAAA) : ")
        date_fin = self.saisir_date("Date de fin (format JJ/MM/AAAA) : ", date_debut)
        description = input("Description du tournoi : ")
        tournoi = Tournoi(nom, lieu, date_debut, date_fin, 4, description=description)

        self.view.afficher_message("Joueurs disponibles pour inscription :")
        for joueur in joueurs_disponibles:
            joueur_obj = Joueur.from_dict(joueur)
            self.view.afficher_joueur_disponible(joueur_obj)

        tournoi.scores = {}
        while True:
            matricule = input("Entrez le matricule du joueur à ajouter (ou '0' pour terminer l'ajout de joueurs) : ")
            if matricule == '0':
                if len(tournoi.joueurs) < 5:
                    self.view.afficher_erreur("Nombre insuffisant de joueurs pour créer un tournoi de 4 rounds.")
                    continue
                break

            joueur = next((j for j in joueurs_disponibles if j['matricule'] == matricule), None)
            if joueur:
                try:
                    tournoi.ajouter_joueur(Joueur.from_dict(joueur))
                    tournoi.scores[joueur['matricule']] = 0
                    self.view.afficher_message(f"Joueur {joueur['prenom']} {joueur['nom']} ajouté.")
                except ValueError as e:
                    self.view.afficher_erreur(str(e))
            else:
                self.view.afficher_erreur("Joueur non trouvé.")

        self.creer_matchs_round_robin(tournoi)
        self.enregistrer_tournoi(tournoi.to_dict())
        self.view.afficher_message("Tournoi créé avec succès.")

    def ajouter_joueur(self):
        while True:
            nom = input("Nom du joueur : ")
            prenom = input("Prénom du joueur : ")
            date_naissance = self.saisir_date("Date de naissance (format JJ/MM/AAAA) : ", datetime(1960, 1, 1))
            matricule = self.saisir_matricule()
            joueur = Joueur(nom, prenom, date_naissance, matricule)
            self.enregistrer_joueur(joueur)
            self.view.afficher_message(f"Joueur {prenom} {nom} ajouté avec succès !")

            autre = input("Voulez-vous ajouter un autre joueur ? (O/N) : ")
            if autre.lower() != 'o':
                break

    def afficher_tous_les_joueurs(self):
        joueurs_data = self.charger_joueurs_inscrits()  # Charge les joueurs depuis le fichier JSON
        joueurs_objs = [Joueur.from_dict(j) for j in joueurs_data]  # Convertir en objets Joueur
        self.view.afficher_tous_les_joueurs(joueurs_objs)

    def afficher_tous_les_tournois(self):
        tournois = self.charger_tous_les_tournois()
        self.view.afficher_tous_les_tournois(tournois)

    def lancer_tournoi(self):
        tournois = self.charger_tous_les_tournois()
        if not tournois:
            self.view.afficher_erreur("Aucun tournoi disponible pour le lancement.")
            return

        for tournoi in tournois:
            self.view.afficher_message(f"Tournoi : {tournoi.nom} - Lieu : {tournoi.lieu}")

        nom_tournoi = input("Entrez le nom du tournoi que vous souhaitez lancer : ")
        tournoi = next((t for t in tournois if t.nom == nom_tournoi), None)

        if not tournoi:
            self.view.afficher_erreur("Tournoi non trouvé.")
            return

        tournoi_obj = Tournoi.from_dict(tournoi.to_dict())
        self.view.afficher_message(f"Lancement du tournoi {tournoi_obj.nom}.")

        joueurs = list(tournoi_obj.joueurs.values())
        random.shuffle(joueurs)

        self.creer_matchs_round_robin(tournoi_obj)

        self.view.afficher_message(f"Rounds du tournoi {tournoi_obj.nom} :")
        for rnd in tournoi_obj.rounds_list:
            self.view.afficher_rounds(rnd)

        if tournoi_obj.rounds_list:
            self.view.afficher_message(f"Lancement du round {tournoi_obj.rounds_list[-1].nom} "
                                       f"du tournoi {tournoi_obj.nom}")

        self.match_scores(tournoi_obj)

    def creer_matchs_round_robin(self, tournoi):
        tournoi.rounds_list = []

        joueurs = tournoi.joueurs
        if not all(isinstance(joueur, Joueur) for joueur in joueurs):
            self.view.afficher_erreur("Les joueurs doivent être des instances de la classe Joueur.")
            return

        random.shuffle(joueurs)
        nombre_joueurs = len(joueurs)

        for i in range(tournoi.nb_rounds):
            round_name = f"Round {i + 1}"
            round_date_debut = datetime.now().strftime('%d/%m/%Y %H:%M:%S')
            round_date_fin = (datetime.now() + timedelta(hours=1)).strftime('%d/%m/%Y %H:%M:%S')
            round_matches = []

            for j in range(0, nombre_joueurs // 2):
                joueur1 = joueurs[j]
                joueur2 = joueurs[-(j + 1)]
                match = Match(joueur1, joueur2)
                round_matches.append(match)

            round_obj = Round(round_name, round_date_debut, round_date_fin, round_matches)
            tournoi.ajouter_round(round_obj)

        self.view.afficher_message("Les matchs ont été créés en mode Round-Robin.")

    def saisir_date(self, prompt, date_reference=None):
        while True:
            date_str = input(prompt)
            try:
                date = datetime.strptime(date_str, '%d/%m/%Y')
                if date_reference and date < date_reference:
                    self.view.afficher_erreur(f"La date doit être postérieure "
                                              f"à {date_reference.strftime('%d/%m/%Y')}.")
                else:
                    return date
            except ValueError:
                self.view.afficher_erreur("Format de date incorrect," 
                                          "veuillez entrer une date valide au format JJ/MM/AAAA.")

    def saisir_matricule(self):
        while True:
            matricule = input("Matricule du joueur (ex: AB12345) : ")
            if len(matricule) != 7 or not matricule[:2].isalpha() or not matricule[2:].isdigit():
                self.view.afficher_erreur("Le matricule doit contenir 2 lettres suivies de 5 chiffres.")
            elif self.matricule_existe(matricule):
                self.view.afficher_erreur("Un joueur avec ce matricule existe déjà.")
            else:
                return matricule

    def matricule_existe(self, matricule):
        joueurs = self.charger_joueurs_inscrits()
        return any(j['matricule'] == matricule for j in joueurs)

    def enregistrer_joueur(self, joueur):
        joueurs = self.charger_joueurs_inscrits()
        joueurs.append(joueur.to_dict())
        with open(self.joueurs_path, 'w') as f:
            json.dump(joueurs, f, indent=4)

    def enregistrer_tournoi(self, tournoi_data):
        tournois = self.charger_tous_les_tournois()
        tournois.append(tournoi_data)
        with open(self.tournois_path, 'w') as f:
            json.dump(tournois, f, indent=4)

    def charger_joueurs_inscrits(self):
        if not os.path.isfile(self.joueurs_path):
            return []
        with open(self.joueurs_path, 'r') as f:
            return json.load(f)

    def charger_tous_les_tournois(self):
        if not os.path.isfile(self.tournois_path):
            return []
        with open(self.tournois_path, 'r') as f:
            return json.load(f)

    def generer_rapport_joueurs(self):
        joueurs_data = self.charger_joueurs_inscrits()
        joueurs_objs = [Joueur.from_dict(j) for j in joueurs_data]
        self.view.afficher_rapport_joueurs(joueurs_objs)

    def generer_rapport_tournois(self):
        tournois = self.charger_tous_les_tournois()
        self.view.afficher_rapport_tournois(tournois)

    def match_scores(self, tournoi):
        for rnd in tournoi.rounds_list:
            for match in rnd.matches:
                score = input(f"Entrez le résultat pour le match {match.joueur1.nom} " 
                              f"contre {match.joueur2.nom} (1, 2 ou N pour nul) : ")
                if score == "1":
                    match.joueur1.points += 1
                elif score == "2":
                    match.joueur2.points += 1
                elif score.lower() == "n":
                    match.joueur1.points += 0.5
                    match.joueur2.points += 0.5
                else:
                    self.view.afficher_erreur("Résultat invalide.")


















    
   

























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































